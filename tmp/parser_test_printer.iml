[@@@require "containers"];;

[@@@import "../fix-engine/src-protocol-pp/parse_full_messages.iml"];;
[@@@import "../fix-engine/src-protocol-pp/encode_full_messages.iml"];;
[@@@import "../fix-engine/src-core-pp/parser_utils.iml"];;

[@@@program]

let pair_s_printer (ppf : CCFormat.formatter) : (string * string) -> unit = function
  | x,y -> CCFormat.fprintf ppf "\"%s\",\"%s\"" x y

let run_one orig_message =
    let message =
      orig_message
      |> Parser_utils.split_into_key_value '|'
      |> Parser_utils.split_into_messages |> CCSeq.take 1i |> CCSeq.to_list |> CCList.hd
      |> Parse_full_messages.parse_top_level_msg Parse_datetime.parse_UTCTimestamp_micro in
    match message with
    | ValidMsg ({ full_msg_data=Full_FIX_App_Msg data ; _ } )->
      let to_print_out = CCFormat.(sprintf "(\"%s\",{msg_tag=\"%s\";payload = [%a]})"
          orig_message data.msg_tag (list ~sep:(return ";") pair_s_printer) data.payload) in

      let oc = open_out_gen [Open_append; Open_creat] 0o666i "tests.pdef" in
      Printf.fprintf oc "%s" to_print_out
    | _ -> failwith "invalid message - cannot parse"
;;

let run () =
  CCList.iter run_one
  ["8=FIX.4.2|9=163|35=D|49=BLP|56=RJCO|34=1575|52=20200401-13:05:28|50=7898513|115=24X|60=20200401-13:05:28|1=24XCARE|38=1|40=2|11=20200401-00001-00001|44=172|21=3|54=1|55=RXM0|59=0|10=149|";
  "8=FIX.4.2|9=163|35=D|49=BLP|56=RJCO|34=1575|52=20200401-13:05:28|50=7898513|115=24X|60=20200401-13:05:28|1=24XCARE|38=1|40=2|11=20200401-00001-00001|44=172|21=3|54=1|55=RXM0|59=0|10=149|"]
;;
[@@@logic]